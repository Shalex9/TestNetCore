@using Newtonsoft.Json;
@model TestNetCore.Models.Files.Crud.CrudViewModel
@{
    ViewData["Title"] = "CRUD";
    Layout = "~/Views/Shared/_LayoutCabinet.cshtml";
}


<form asp-controller="Crud" asp-action="Crud"
      id="Crud"
      method="post" enctype="multipart/form-data"
      class="col-md-12">
    @Html.AntiForgeryToken()
    <h2 id="">CRUD операции с файлами. Страница в стадии разработки</h2>
    <p>Основные действия с файлами на сервере(для примера, поработаем с текстовыми файлами) - создание(Create), чтение(Read), изменение(Update), удаление(Delete)</p>

    <div class="row asRow">
        <h4>Создайте текстовый файл или загрузите существующий файл любого текстового формата</h4>
        <div class="boxButton">
            <button id="btnCreate" type="button" class="btn btn-primary" data-toggle="modal" data-target="#createModal">Создать файл</button>

            <div id="chooseFile" class="file_upload">
                <button type="button" id="uploadBtn" onclick="return uploadFiles('uploadFiles')">
                    <span class="glyphicon glyphicon-cloud-upload"></span>
                    <span id="download">Загрузить</span>
                </button>
                <div id="fileName" style="margin-top: 5px;">Файл не выбран</div>
                <input type="file" name="files" id="files" accept="text/*" />
                <button type="submit" id="pushFile" class="display-none uploadFile">Button</button>
            </div>
        </div>
        <div class="boxFiles">
            @if (Model.CountFiles == 0)
            {
                <p>Еще не создано/загружено ни одного файла. Самое время приступать!</p>
            }
            else
            {
                <p>Ваш файл(ы): </p>
                @if (Model.FileName1 != null)
                {
                    <p>Название: @Model.FileName1 Размер: @Model.FileSize1</p>
                }
                if (Model.FileName2 != null)
                {
                    <p>Название: @Model.FileName2 Размер: @Model.FileSize2</p>
                }
            }
        </div>
    </div>


    <div class="row asRow">

    </div>

    <hr />

    <p>Кстати, больше информации обо мне - в моем резюме, можете скачать)</p>
    <a asp-controller="Crud" is-active-route asp-action="GetResume"
       id="downloadResume"
       class="defaultStyleButton"
       style="margin-top: 25px;">
        <i class="fa fa-floppy-o" aria-hidden="true" id="save"></i>
        <span id="downloadResumeText">Загрузить моё резюме</span>
    </a>

    <hr />


    <div id="alertSave" class="alertMsg" style="display: none;">
        Ваш файл успешно сохранен на сервере
    </div>

    <div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="createModalLabel">Создание файла</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="recipient-name" class="control-label">Название файла(расширение по умолчанию .txt):</label>
                        <input type="text" class="form-control" id="fileName">
                    </div>
                    <div class="form-group">
                        <label for="message-text" class="control-label">Текст файла:</label>
                        <textarea class="form-control" id="fileText"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="return createFile()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" asp-for="PostType" id="PostType" />
    <input type="hidden" asp-for="TypeUploadFile" id="TypeUploadFile" />

</form>


    <script>
        var countFiles = @Model.CountFiles;
        console.log(countFiles);
        if (countFiles == 2) {
            $("#btnCreate").attr("disabled", "disable"); 
            $("chooseFile").attr("disabled", "disable");
            $(".boxButton").append("<h4>Уже создано два файла. Это максимум!</h4>");
        } 
        function uploadFiles(val) {
            $("#PostType").val(val);
            $("button.uploadImg").click();
            return true;
        }

        function createFile(val) {
            $("#PostType").val(val);
        }

        // ADD FILES
        var wrapper = $(".file_upload"),
            inp = wrapper.find("input"),
            btn = wrapper.find("button#uploadBtn"),
            push = wrapper.find("button#pushFile"),
            lbl = wrapper.find("div#fileName");
        btn.focus(function () {
            wrapper.addClass("focus");
        }).blur(function () {
            wrapper.removeClass("focus");
        });
        btn.add(lbl).click(function () {
            inp.click();
        });
        var file_api = (window.File && window.FileReader && window.FileList && window.Blob) ? true : false;
        inp.change(function () {
            var file_name;
            if (file_api && inp[0].files[0])
                file_name = inp[0].files[0].name;
            else
                file_name = inp.val().replace("C:\\somepath\\", '');
            if (!file_name.length)
                return;
            if (lbl.is(":visible")) {
                lbl.text(file_name);
                btn.text("Загрузка файла");
            } else
                btn.text(file_name);
            // for Get Type file
            var file = $("#files")[0].files[0],
                ext = "не определилось",
                parts = file.type.split('/');
            if (parts.length > 1) ext = parts.shift();
            console.log("MIME тип: ", ext);
            $("#TypeUploadFile").val(ext);

            push.click();
        }).change();


        function createFile() {
            var token = $('input[name="__RequestVerificationToken"]', $('#Crud')).val();
            var fileName = $("#fileName").val();
            var fileText = $("#fileText").val();
            var myData = { fileName: fileName, fileText: fileText };
            var dataWithAntiforgeryToken = $.extend(myData, { '__RequestVerificationToken': token });

            $.ajax({
                url: "/Crud/CreateFile",
                type: "POST",
                data: dataWithAntiforgeryToken,
                success: function (data) {
                    console.log("data: ", data);
                    
                    if (data.countFiles == 2) {
                        countFiles = 2;
                    } 

                    $("#alertSave").css("display", "block");
                    setInterval(function () {
                        $("#alertSave").css("display", "none");
                    }, 4 * 1000);
                }
            });
        }
    </script>
